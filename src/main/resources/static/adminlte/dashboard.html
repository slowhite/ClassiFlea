<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <base href="/adminlte/">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ClassiFlea | Dashboard</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <link rel="stylesheet" href="dist/css/adminlte.min.css">
  <style>
    .table td, .table th { vertical-align: middle; }
    .empty-row td { color:#6c757d; text-align:center; padding:1rem 0; }
  </style>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a></li>
      <li class="nav-item d-none d-sm-inline-block"><a href="starter.html" class="nav-link">个人信息</a></li>
    </ul>
    <ul class="navbar-nav ml-auto">
      <li class="nav-item"><a class="nav-link" data-widget="navbar-search" href="#" role="button"><i class="fas fa-search"></i></a></li>
      <li class="nav-item"><a class="nav-link" data-widget="fullscreen" href="#" role="button"><i class="fas fa-expand-arrows-alt"></i></a></li>
      <li class="nav-item"><a class="nav-link" data-widget="control-sidebar" data-slide="true" href="#" role="button"><i class="fas fa-th-large"></i></a></li>
    </ul>
  </nav>

  <!-- Sidebar -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="dashboard.html" class="brand-link">
      <img src="dist/img/AdminLTELogo.png" class="brand-image img-circle elevation-3" style="opacity:.8" alt="">
      <span class="brand-text font-weight-light">ClassiFlea</span>
    </a>
    <div class="sidebar">
      <div class="user-panel mt-3 pb-3 mb-3 d-flex align-items-center">
        <div class="image"><img id="sidebarAvatar" class="img-circle elevation-2" src="dist/img/user2-160x160.jpg" alt="avatar" style="width:33px;height:33px;object-fit:cover;"></div>
        <div class="info">
          <a href="starter.html" class="d-block" id="sidebarNickname">User</a>
          <small id="sidebarEmail" class="text-muted d-block" style="font-size:12px;"></small>
        </div>
      </div>
      <nav class="mt-2">
        <ul id="leftNav" class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
          <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="nav-icon fas fa-tachometer-alt"></i><p>Dashboard &#128640;</p></a></li>
          <li class="nav-item has-treeview">
            <a href="#" class="nav-link"><i class="nav-icon fas fa-store"></i><p>我是卖家<i class="right fas fa-angle-left"></i></p></a>
            <ul class="nav nav-treeview"><li class="nav-item"><a href="edge_mine.html" class="nav-link"><i class="far fa-circle nav-icon"></i><p>卖出商品</p></a></li></ul>
          </li>
          <li class="nav-item has-treeview">
            <a href="#" class="nav-link"><i class="nav-icon fas fa-shopping-bag"></i><p>我是买家<i class="right fas fa-angle-left"></i></p></a>
            <ul class="nav nav-treeview">
              <li class="nav-item"><a href="market.html" class="nav-link"><i class="far fa-circle nav-icon"></i><p>市场</p></a></li>
              <li class="nav-item"><a href="purchased.html" class="nav-link"><i class="far fa-circle nav-icon"></i><p>已购商品</p></a></li>
            </ul>
          </li>
          <li class="nav-item"><a href="starter.html" class="nav-link"><i class="nav-icon fas fa-user-cog"></i><p>个人资料</p></a></li>
          <li class="nav-item">
            <a href="#" class="nav-link" id="sidebarLogout"><i class="nav-icon fas fa-sign-out-alt"></i><p>退出登录</p></a>
            <form id="sidebarLogoutForm" action="/logout" method="post" style="display:none"></form>
          </li>
        </ul>
      </nav>
    </div>
  </aside>

  <!-- Content -->
  <div class="content-wrapper">
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6"><h1 class="m-0">ClassiFlea</h1></div>
          <div class="col-sm-6"><ol class="breadcrumb float-sm-right"><li class="breadcrumb-item"><a href="#">Home</a></li></ol></div>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="container-fluid">
        <div class="row">
          <!-- 左：钱包 + 充值记录 -->
          <div class="col-lg-6">
            <div class="card card-outline card-info">
              <div class="card-header d-flex align-items-center justify-content-between">
                <h3 class="card-title mb-0"><i class="fas fa-wallet mr-1"></i> 钱包 Wallet</h3>
              </div>
              <div class="card-body">
                <div class="small-box bg-info mb-0">
                  <div class="inner">
                    <p class="mb-1 text-uppercase text-sm">余额 Balance</p>
                    <h3 class="mb-0">¥<span id="balanceYuan">--</span></h3>
                    <div class="d-flex justify-content-end mt-3">
                      <button class="btn btn-sm btn-info mr-2" onclick="openRedeem()"><i class="fas fa-gift mr-1"></i> 兑换码</button>
                      <button class="btn btn-sm btn-info" onclick="openTopup()"><i class="fas fa-plus-circle mr-1"></i> 充值</button>
                    </div>
                  </div>
                  <div class="icon"><i class="fas fa-yen-sign"></i></div>
                  <a href="javascript:void(0)" class="small-box-footer" onclick="refreshBalance()">刷新余额 <i class="fas fa-sync-alt"></i></a>
                </div>
              </div>
            </div>

            <!-- 充值记录 -->
            <div class="card card-outline card-primary">
              <div class="card-header">
                <h3 class="card-title">充值记录</h3>
                <div class="card-tools"><button class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button></div>
              </div>
              <div class="card-body p-0 table-responsive">
                <table class="table table-hover mb-0" id="walletHistory">
                  <thead><tr><th style="width:40%">时间</th><th>描述</th><th class="text-right" style="width:20%">金额</th></tr></thead>
                  <tbody><tr class="empty-row"><td colspan="3">No data</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- 右：消费记录 -->
          <div class="col-lg-6">
            <div class="card card-outline card-warning">
              <div class="card-header">
                <h3 class="card-title">消费记录</h3>
                <div class="card-tools"><button class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button></div>
              </div>
              <div class="card-body p-0 table-responsive">
                <table class="table table-hover mb-0" id="orderHistory">
                  <thead><tr><th style="width:40%">时间</th><th>编号</th><th class="text-right" style="width:20%">状态</th></tr></thead>
                  <tbody><tr class="empty-row"><td colspan="3">No data</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
          <!-- /右 -->
        </div>
      </div>
    </div>
  </div>

  <aside class="control-sidebar control-sidebar-dark"></aside>
</div>

<!-- libs -->
<script src="plugins/jquery/jquery.min.js"></script>
<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="dist/js/adminlte.js"></script>

<!-- 充值弹窗 -->
<div class="modal fade" id="topupModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">充值</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>金额（元）</label><input id="topup-amount" type="number" step="0.01" min="0.01" class="form-control" placeholder="例如 10.00"></div>
      <div class="form-group"><label>方式</label>
        <select id="topup-method" class="form-control">
          <option value="CAMPUS_CARD">校园卡</option>
          <option value="BANK">银行卡</option>
        </select>
      </div>
      <div class="form-group mb-0"><label>备注（可选）</label><input id="topup-desc" class="form-control" placeholder="例如 期初余额 / 转入"></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-dismiss="modal">取消</button><button class="btn btn-primary" id="topup-submit" onclick="doTopup()">确认充值</button></div>
  </div></div>
</div>

<!-- 兑换码弹窗 -->
<div class="modal fade" id="redeemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">兑换码</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div>
    <div class="modal-body"><div class="form-group mb-0"><label>兑换码</label><input id="redeem-code" class="form-control" placeholder="如 CLASSIFLEA100"></div></div>
    <div class="modal-footer"><button class="btn btn-secondary" data-dismiss="modal">关闭</button><button class="btn btn-info" onclick="doRedeem()">兑换</button></div>
  </div></div>
</div>

<script>
  // 统一 fetch
  window.$fetch = window.$fetch || (typeof window.authedFetch === 'function' ? window.authedFetch : window.fetch);

  // Sidebar 基础
  async function hydrateSidebar(){
    try{
      const rMe = await $fetch('/me', {cache:'no-store', credentials:'same-origin'});
      if (!rMe.ok) return;
      const me = await rMe.json();
      const rP  = await $fetch('/profile', {cache:'no-store', credentials:'same-origin'});
      const p   = rP.ok ? await rP.json() : {};
      const nick = (p.nickname && p.nickname.trim()) ? p.nickname.trim() : me.email;
      const avatar = (p.avatarUrl && p.avatarUrl.trim()) ? p.avatarUrl.trim() : 'dist/img/user2-160x160.jpg';
      document.getElementById('sidebarNickname').textContent = nick;
      document.getElementById('sidebarEmail').textContent    = me.email || '';
      document.getElementById('sidebarAvatar').src           = avatar;
    }catch(e){ /* ignore */ }
  }
  function activateSidebar(){
    const path = location.pathname.replace(/^\/+|\/+$/g, '');
    document.querySelectorAll('.main-sidebar a.nav-link').forEach(a=>{
      const href = (a.getAttribute('href') || '').replace(/^\/+|\/+$/g, '');
      if (href && path.endsWith(href)){
        a.classList.add('active');
        const parent = a.closest('.has-treeview');
        if (parent){ parent.classList.add('menu-open'); const top = parent.querySelector(':scope > a.nav-link'); if (top) top.classList.add('active'); }
      }
    });
  }

  // 余额
  async function refreshBalance(){
    try{
      const r = await $fetch('/wallet', {cache:'no-store', credentials:'same-origin'});
      if(!r.ok) throw new Error('HTTP ' + r.status);
      const data = await r.json();
      const yuan = (typeof data.balance === 'number') ? data.balance
                 : (typeof data.balanceCents === 'number' ? data.balanceCents/100 : 0);
      document.getElementById('balanceYuan').textContent = yuan.toFixed(2);
    }catch(e){
      document.getElementById('balanceYuan').textContent = '--';
    }
  }

  // 充值
  function openTopup(){
    document.getElementById('topup-amount').value = '';
    document.getElementById('topup-desc').value   = '';
    $('#topupModal').modal('show');
  }
  async function doTopup(){
    const btn = document.getElementById('topup-submit');
    const amount = parseFloat(document.getElementById('topup-amount').value || '0');
    const method = document.getElementById('topup-method').value || 'CAMPUS_CARD';
    const desc   = document.getElementById('topup-desc').value || '';
    if(!(amount > 0)){ alert('金额必须大于 0'); return; }
    btn.disabled = true;
    try{
      const r = await $fetch('/wallet/topup', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify({ amount, method, description: desc }) // 后端读取的是 amount
      });
      if(!r.ok){
        const msg = (r.headers.get('content-type')||'').includes('json') ? (await r.json()).error : (await r.text());
        throw new Error(msg || ('HTTP ' + r.status));
      }
      $('#topupModal').modal('hide');
      await refreshBalance();
      alert('充值成功！');
    }catch(e){ alert('充值失败：' + (e.message || '')); }
    finally{ btn.disabled = false; }
  }

  // 兑换码
  function openRedeem(){
    document.getElementById('redeem-code').value = '';
    $('#redeemModal').modal('show');
  }
  async function doRedeem(){
    const btn = document.querySelector('#redeemModal .btn.btn-info');
    const code = (document.getElementById('redeem-code').value || '').trim();
    if(!code){ alert('请输入兑换码'); return; }
    btn && (btn.disabled = true);
    try{
      const r = await $fetch('/wallet/redeem', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify({ code })
      });
      if(!r.ok){
        let details = '';
        const ct = r.headers.get('content-type') || '';
        if (ct.includes('application/json')) {
          const j = await r.json();
          details = j.message || j.error || '';
        } else { details = await r.text(); }

        if (r.status === 409)       throw new Error('该兑换码已被使用');
        else if (r.status === 400)  throw new Error('礼品码错误或已失效');
        else                        throw new Error(details || ('HTTP ' + r.status));
      }
      $('#redeemModal').modal('hide');
      await refreshBalance();
      alert('兑换成功！');
    }catch(e){ alert(e.message || '兑换失败'); }
    finally{ btn && (btn.disabled = false); }
  }

  // 历史列表
  async function loadWalletHistory(){
    const tb = document.querySelector('#walletHistory tbody'); if(!tb) return;
    try{
      const r = await $fetch('/wallet/txns', {cache:'no-store', credentials:'same-origin'});
      if(!r.ok) throw 0;
      const list = (await r.json()) || [];
      const top10 = Array.isArray(list) ? list.slice(0,10) : [];
      if(top10.length===0){
        tb.innerHTML = '<tr class="empty-row"><td colspan="3">No transactions</td></tr>';
        return;
      }
      tb.innerHTML = top10.map(tx=>{
        const amt = typeof tx.amount === 'number' ? tx.amount
                 : (typeof tx.amountCents === 'number' ? tx.amountCents/100 : 0);
        const sign = amt>=0 ? '+' : '';
        const cls  = amt>=0 ? 'text-success' : 'text-danger';
        const when = tx.createdAt ? new Date(tx.createdAt).toLocaleString() : '';
        const desc = esc(tx.desc || tx.description || tx.type || 'Transaction');
        return `<tr><td>${when}</td><td>${desc}</td><td class="text-right ${cls}">${sign}${amt.toFixed(2)}</td></tr>`;
      }).join('');
    }catch{
      tb.innerHTML = '<tr class="empty-row"><td colspan="3">—</td></tr>';
    }
  }
  async function loadOrderHistory(){
    const tb = document.querySelector('#orderHistory tbody'); if(!tb) return;
    try{
      const r = await $fetch('/orders?mine=1&limit=5', {cache:'no-store', credentials:'same-origin'});
      if(!r.ok) throw 0;
      const list = await r.json();
      const arr = Array.isArray(list) ? list.slice(0,10) : [];
      if(arr.length===0){
        tb.innerHTML = '<tr class="empty-row"><td colspan="3">No orders</td></tr>';
        return;
      }
      tb.innerHTML = arr.map(o=>{
        const when = o.createdAt ? new Date(o.createdAt).toLocaleString() : '';
        const lid  = o.listingId ?? '';
        const st   = esc(o.status || '');
        return `<tr><td>${when}</td><td>#${lid}</td><td class="text-right">${st}</td></tr>`;
      }).join('');
    }catch{
      tb.innerHTML = '<tr class="empty-row"><td colspan="3">—</td></tr>';
    }
  }

  function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // 侧栏退出
  document.getElementById('sidebarLogout')?.addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('sidebarLogoutForm')?.submit(); });

  // 启动
  document.addEventListener('DOMContentLoaded', ()=>{
    activateSidebar();
    hydrateSidebar();
    refreshBalance();
    loadWalletHistory();
    loadOrderHistory();
  });

  // 导出给 onclick
  Object.assign(window, { openTopup, doTopup, openRedeem, doRedeem, refreshBalance });
</script>
</body>
</html>
